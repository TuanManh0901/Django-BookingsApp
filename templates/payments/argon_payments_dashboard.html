{% load static %}
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Payments Dashboard</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700">
  <link rel="stylesheet" href="{% static 'argon-dashboard-master/assets/css/nucleo-icons.css' %}">
  <link rel="stylesheet" href="{% static 'argon-dashboard-master/assets/css/nucleo-svg.css' %}">
  <link rel="stylesheet" href="{% static 'argon-dashboard-master/assets/css/argon-dashboard.min.css' %}">
  <style>
    body { background: #f8f9fe; }
    .badge-soft { padding: 6px 10px; border-radius: 4px; font-weight: 600; font-size: 12px; }
    .badge-soft.pending_payment { background: #fff3cd; color: #856404; }
    .badge-soft.paid_successfully { background: #d4edda; color: #155724; }
    .badge-soft.payment_failed { background: #f8d7da; color: #721c24; }
    .badge-soft.cancelled { background: #e2e3e5; color: #383d41; }
    .btn-light { border: 1px solid #dcdfe4; }
    .table thead th { text-transform: uppercase; font-size: 11px; letter-spacing: .5px; color: #8898aa; }
    .table td { vertical-align: middle; }
    .text-xs { font-size: 12px; }
    .filters select { min-width: 180px; }
    .top-actions { gap: 10px; }
    .selected-count { font-weight: 600; color: #32325d; }
  </style>
</head>
<body class="g-sidenav-show bg-gray-100">
  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">
    <div class="container-fluid py-4">
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header pb-3 d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
              <div>
                <h5 class="mb-1">Payments (Argon Dashboard)</h5>
                <p class="text-sm text-muted mb-0">Chỉ dành cho staff. Bạn có thể chọn tất cả và xóa hàng loạt.</p>
              </div>
              <div class="d-flex top-actions">
                <button id="btn-select-all" class="btn btn-sm btn-primary">Chọn tất cả</button>
                <button id="btn-clear" class="btn btn-sm btn-light">Bỏ chọn</button>
                <button id="btn-delete" class="btn btn-sm btn-danger" disabled>Xóa đã chọn</button>
              </div>
            </div>
            <div class="card-body pt-0">
              <form method="get" class="filters row g-2 mb-3">
                <div class="col-12 col-md-4">
                  <label class="form-label text-xs text-uppercase text-muted">Phương thức</label>
                  <select class="form-select" name="method" onchange="this.form.submit()">
                    <option value="">Tất cả</option>
                    {% for value,label in method_choices %}
                      <option value="{{ value }}" {% if method_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label text-xs text-uppercase text-muted">Trạng thái</label>
                  <select class="form-select" name="status" onchange="this.form.submit()">
                    <option value="">Tất cả</option>
                    {% for value,label in status_choices %}
                      <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-12 col-md-4 d-flex align-items-end">
                  <a href="{% url 'argon_payments_dashboard' %}" class="btn btn-outline-secondary w-100">Reset filter</a>
                </div>
              </form>

              <div class="table-responsive">
                <table class="table align-items-center mb-0" id="payments-table">
                  <thead>
                    <tr>
                      <th class="text-center" style="width: 45px;">
                        <div class="form-check form-check-lg">
                          <input class="form-check-input" type="checkbox" id="toggle-all">
                        </div>
                      </th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">ID</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Booking</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">User</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Amount</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Method</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Status</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Transaction</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Created</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for payment in page_obj %}
                      <tr data-id="{{ payment.id }}">
                        <td class="text-center">
                          <div class="form-check">
                            <input class="form-check-input row-checkbox" type="checkbox" value="{{ payment.id }}">
                          </div>
                        </td>
                        <td class="text-sm font-weight-bold">#{{ payment.id }}</td>
                        <td class="text-sm">Booking {{ payment.booking_id }}</td>
                        <td class="text-sm">{{ payment.user.username }}</td>
                        <td class="text-sm">{{ payment.amount }}</td>
                        <td class="text-sm">{{ payment.get_method_display }}</td>
                        <td class="text-sm">
                          <span class="badge-soft {{ payment.status }}">{{ payment.get_status_display }}</span>
                        </td>
                        <td class="text-sm">{{ payment.transaction_ref|default:'-' }}</td>
                        <td class="text-sm">{{ payment.created_at|date:"d/m/Y H:i" }}</td>
                      </tr>
                    {% empty %}
                      <tr>
                        <td colspan="9" class="text-center text-muted py-4">Không có payment nào.</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>

              <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mt-3">
                <div class="selected-count">Đã chọn: <span id="selected-count">0</span></div>
                <nav aria-label="Pagination" class="mt-2 mt-md-0">
                  <ul class="pagination pagination-sm mb-0">
                    {% if page_obj.has_previous %}
                      <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if method_filter %}&method={{ method_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">&laquo;</a></li>
                    {% else %}
                      <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                    {% endif %}

                    <li class="page-item active"><span class="page-link">Trang {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>

                    {% if page_obj.has_next %}
                      <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if method_filter %}&method={{ method_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">&raquo;</a></li>
                    {% else %}
                      <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                    {% endif %}
                  </ul>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="{% static 'argon-dashboard-master/assets/js/core/popper.min.js' %}"></script>
  <script src="{% static 'argon-dashboard-master/assets/js/core/bootstrap.min.js' %}"></script>
  <script src="{% static 'argon-dashboard-master/assets/js/argon-dashboard.min.js' %}"></script>
  <script>
    (function() {
      const toggleAll = document.getElementById('toggle-all');
      const rowCheckboxes = Array.from(document.querySelectorAll('.row-checkbox'));
      const btnSelectAll = document.getElementById('btn-select-all');
      const btnClear = document.getElementById('btn-clear');
      const btnDelete = document.getElementById('btn-delete');
      const selectedCountEl = document.getElementById('selected-count');
      const csrfToken = '{{ csrf_token }}';
      const deleteUrl = '{% url "argon_payments_bulk_delete" %}';

      function updateState() {
        const checked = rowCheckboxes.filter(cb => cb.checked);
        selectedCountEl.textContent = checked.length;
        btnDelete.disabled = checked.length === 0;
        toggleAll.checked = checked.length === rowCheckboxes.length && rowCheckboxes.length > 0;
      }

      btnSelectAll.addEventListener('click', function() {
        rowCheckboxes.forEach(cb => { cb.checked = true; });
        updateState();
      });

      btnClear.addEventListener('click', function() {
        rowCheckboxes.forEach(cb => { cb.checked = false; });
        updateState();
      });

      toggleAll.addEventListener('change', function(e) {
        const checked = e.target.checked;
        rowCheckboxes.forEach(cb => { cb.checked = checked; });
        updateState();
      });

      rowCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateState);
      });

      btnDelete.addEventListener('click', async function() {
        const ids = rowCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
        if (!ids.length) return;
        if (!confirm(`Bạn chắc chắn muốn xóa ${ids.length} payment?`)) return;

        btnDelete.disabled = true;
        btnDelete.textContent = 'Đang xóa...';

        try {
          const res = await fetch(deleteUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({ ids }),
          });

          if (!res.ok) {
            alert('Xóa thất bại. Vui lòng thử lại.');
            return;
          }

          const data = await res.json();
          // Remove rows from DOM
          rowCheckboxes.forEach(cb => {
            if (cb.checked) {
              const row = cb.closest('tr');
              if (row) row.remove();
            }
          });

          alert(`Đã xóa ${data.deleted || 0} payment`);
        } catch (err) {
          alert('Có lỗi xảy ra, vui lòng thử lại.');
        } finally {
          btnDelete.textContent = 'Xóa đã chọn';
          // refresh references after DOM changes
          const newCheckboxes = Array.from(document.querySelectorAll('.row-checkbox'));
          rowCheckboxes.length = 0;
          newCheckboxes.forEach(cb => rowCheckboxes.push(cb));
          updateState();
        }
      });

      updateState();
    })();
  </script>
</body>
</html>
